<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LandScore | 土地評価スコアリング</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --soft:#1f2937; --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --warn:#f59e0b; --bad:#ef4444; --line:#334155;
    --radius:12px;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a 30%,#0b1220);color:var(--text)}
  header{position:sticky;top:0;background:rgba(15,23,42,.8);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:10}
  .wrap{max-width:1080px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:0;display:flex;gap:10px;align-items:center}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
  .row{display:grid;grid-template-columns:1fr 100px 110px 90px auto;gap:8px;align-items:center;margin:8px 0}
  .row input[type="range"]{width:100%}
  .row input[type="number"]{width:100%;background:#0b1220;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px}
  .row .label{display:flex;gap:6px;align-items:center}
  .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
  .section-title{display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px 0}
  .section-title h2{font-size:16px;margin:0}
  button{background:var(--soft);color:var(--text);border:1px solid var(--line);padding:10px 14px;border-radius:10px;cursor:pointer}
  button:hover{filter:brightness(1.05)}
  .primary{background:var(--accent);border-color:#16a34a;color:#06230f;font-weight:700}
  .danger{background:var(--bad);border-color:#dc2626}
  .warn{background:var(--warn);border-color:#d97706;color:#1f1300}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  .score-box{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .total{background:linear-gradient(180deg,#052e1a,#06230f);border:1px solid #14532d;border-radius:14px;padding:16px}
  .meter{height:12px;border-radius:999px;background:#0b1220;border:1px solid var(--line);overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,#ef4444,#f59e0b,#22c55e);width:0%}
  .grade{font-size:26px;margin:0}
  .muted{color:var(--muted)}
  details{border:1px dashed var(--line);border-radius:10px;padding:10px}
  details[open]{background:#0b1220}
  .tiny{font-size:12px}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi .chip{background:#0b1220;border:1px solid var(--line);border-radius:10px;padding:6px 10px}
  .right{display:flex;gap:8px;align-items:center}
  .note{width:100%;min-height:90px;background:#0b1220;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px}
  .foot{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted);margin-top:8px}
  .link{color:#a5b4fc;text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:12px">
    <h1>🏡 LandScore <span class="pill">土地評価スコアリング</span></h1>
    <div class="toolbar">
      <button id="save">保存</button>
      <button id="load">読み込み</button>
      <button id="export">エクスポート</button>
      <button id="import">インポート</button>
      <button id="reset" class="danger">初期化</button>
    </div>
  </div>
</header>

<main class="wrap" style="margin-top:12px">
  <div class="grid">
    <section class="card" id="left">
      <div class="section-title"><h2>評価カテゴリ & 項目</h2>
        <div class="right">
          <button id="addCategory">＋ カテゴリ追加</button>
          <button id="addItem">＋ 項目追加</button>
        </div>
      </div>
      <div id="list"></div>
      <details style="margin-top:12px">
        <summary>重み（％）と配点の考え方（クリックで展開）</summary>
        <p class="tiny">カテゴリの重みは合計100％になるよう自動調整されます。各項目は0〜5点（初期）を推奨。必要に応じて最大点を変更できます。</p>
      </details>
    </section>

    <section class="card" id="right">
      <div class="section-title"><h2>結果</h2>
        <div class="right">
          <button id="print" class="warn">PDF/印刷</button>
        </div>
      </div>

      <div class="score-box">
        <div class="total">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 class="grade" id="totalScore">0 点</h3>
            <div class="kpi">
              <div class="chip">評価: <b id="verdict">—</b></div>
              <div class="chip">閾値: <span id="threshold">75点＝「買い」</span></div>
            </div>
          </div>
          <div class="meter" style="margin:8px 0 6px"><div class="bar" id="bar"></div></div>
          <div class="muted tiny">合計100点満点（重み×配点の加重平均）</div>
        </div>
        <div class="card" style="background:#0b1220">
          <div class="section-title" style="margin:0"><h2 style="font-size:14px">判定ルール</h2></div>
          <div class="tiny">
            <ul>
              <li>90〜100：<b>希少で強く推奨</b></li>
              <li>75〜89：<b>購入推奨</b></li>
              <li>60〜74：<b>条件付き購入</b>（建物計画で補正）</li>
              <li>〜59：<b>見送り推奨</b></li>
            </ul>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <label class="tiny">「買い」閾値：</label>
            <input type="number" id="buyThreshold" min="0" max="100" step="1" value="75" />
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;background:#0b1220">
        <div class="section-title" style="margin:0"><h2 style="font-size:14px">所見・メモ</h2></div>
        <textarea id="notes" class="note" placeholder="現地での気づき、近隣状況、交渉材料、追加コスト見込み（例：地盤改良120万円、擁壁確認要 など）"></textarea>
      </div>

      <div class="foot">
        <div>ローカル保存：自動（操作ボタンでも保存可能）</div>
        <div>ver 0.9 • © LandScore</div>
      </div>
    </section>
  </div>
</main>

<script>
const DEFAULT_MODEL = {
  meta:{version:"0.9",updated:Date.now()},
  threshold:75,
  categories:[
    {
      id:crypto.randomUUID(), name:"立地・利便性", weight:30,
      items:[
        {id:crypto.randomUUID(), name:"交通アクセス（駅・通勤）", score:3, max:5, help:"最寄駅距離、所要時間、バス本数"},
        {id:crypto.randomUUID(), name:"生活利便性（スーパー・病院等）", score:3, max:5},
        {id:crypto.randomUUID(), name:"将来性（人口推移・再開発）", score:3, max:5}
      ]
    },
    {
      id:crypto.randomUUID(), name:"環境・安全性", weight:25,
      items:[
        {id:crypto.randomUUID(), name:"災害リスク（洪水・土砂・津波・地震）", score:3, max:5},
        {id:crypto.randomUUID(), name:"周辺環境（治安・騒音・景観）", score:3, max:5},
        {id:crypto.randomUUID(), name:"日当たり・風通し", score:3, max:5}
      ]
    },
    {
      id:crypto.randomUUID(), name:"土地形状・物理条件", weight:25,
      items:[
        {id:crypto.randomUUID(), name:"形状・間口（プラン自由度）", score:3, max:5},
        {id:crypto.randomUUID(), name:"道路付け（方位・幅員・SB）", score:3, max:5},
        {id:crypto.randomUUID(), name:"高低差・排水", score:3, max:5}
      ]
    },
    {
      id:crypto.randomUUID(), name:"法規制・コスト", weight:20,
      items:[
        {id:crypto.randomUUID(), name:"建ぺい率・容積率（計画適合）", score:3, max:5},
        {id:crypto.randomUUID(), name:"用途地域（周辺用途の安定性）", score:3, max:5},
        {id:crypto.randomUUID(), name:"ライフライン（上下水・ガス・電気）", score:3, max:5},
        {id:crypto.randomUUID(), name:"追加コスト（解体・造成・改良）", score:3, max:5}
      ]
    }
  ],
  notes:""
};

let model = loadLocal() || DEFAULT_MODEL;

const $ = (s,root=document)=>root.querySelector(s);
const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));

function saveLocal(){
  model.meta.updated = Date.now();
  localStorage.setItem("landscore", JSON.stringify(model));
}

function loadLocal(){
  const raw = localStorage.getItem("landscore");
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}

function exportJSON(){
  const blob = new Blob([JSON.stringify(model,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "landscore.json"; a.click();
  URL.revokeObjectURL(url);
}

function importJSON(){
  const inp = document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange = () => {
    const file = inp.files?.[0]; if(!file) return;
    const fr = new FileReader();
    fr.onload = () => {
      try{
        const data = JSON.parse(fr.result);
        if(!data.categories) throw new Error("不正な形式");
        model = data; render();
        saveLocal();
      }catch(e){ alert("読み込み失敗："+e.message); }
    };
    fr.readAsText(file);
  };
  inp.click();
}

function normalizeWeights(){
  const sum = model.categories.reduce((a,c)=>a + (Number(c.weight)||0), 0);
  if(sum===100 || sum===0) return;
  model.categories.forEach(c=>{
    c.weight = Math.round((c.weight/sum)*100);
  });
  let diff = 100 - model.categories.reduce((a,c)=>a+c.weight,0);
  for(let i=0; diff!==0 && i<model.categories.length; i++){
    model.categories[i].weight += diff>0?1:-1;
    diff += diff>0?-1:1;
  }
}

function calcScore(){
  let total = 0;
  model.categories.forEach(cat=>{
    const items = cat.items.length?cat.items:[];
    const avg = items.length ? items.reduce((a,it)=>a + (it.score/it.max),0)/items.length : 0;
    total += (avg*100) * (cat.weight/100);
  });
  return Math.round(total);
}

function verdict(score){
  if(score>=90) return "希少で強く推奨";
  if(score>=model.threshold) return "購入推奨";
  if(score>=60) return "条件付き購入";
  return "見送り推奨";
}

function render(){
  normalizeWeights();
  document.getElementById("list").innerHTML = "";
  model.categories.forEach((cat,ci)=>{
    const box = document.createElement("div");
    box.className="card";
    box.style.marginBottom="12px";
    box.innerHTML = `
      <div class="section-title">
        <h2>${cat.name}</h2>
        <div class="right">
          <span class="pill">重み</span>
          <input type="number" min="0" max="100" step="1" value="${cat.weight}" style="width:80px;background:#0b1220;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px" />
          <button data-act="rename">名称変更</button>
          <button data-act="delCat" class="danger">削除</button>
        </div>
      </div>
      <div class="row" style="font-size:12px;color:#94a3b8;border-bottom:1px dashed var(--line);padding-bottom:6px">
        <div>項目名</div><div>スコア</div><div>最大点</div><div>比率</div><div></div>
      </div>
      <div class="items"></div>
    `;
    const weightInput = box.querySelector("input[type=number]");
    weightInput.oninput = e => { cat.weight = Number(e.target.value||0); saveLocal(); render(); };
    box.querySelector("[data-act=rename]").onclick = ()=>{
      const name = prompt("カテゴリ名", cat.name);
      if(name){ cat.name=name; saveLocal(); render(); }
    };
    box.querySelector("[data-act=delCat]").onclick = ()=>{
      if(confirm("このカテゴリを削除しますか？")){ model.categories.splice(ci,1); saveLocal(); render(); }
    };

    const itemsWrap = box.querySelector(".items");
    cat.items.forEach((it,ii)=>{
      const row = document.createElement("div");
      row.className="row";
      const ratio = ((it.score/it.max)*100).toFixed(0)+"%";
      row.innerHTML = `
        <div class="label">
          <span class="pill">${ii+1}</span>
          <input type="text" value="${it.name}" style="flex:1;background:#0b1220;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px">
        </div>
        <input type="range" min="0" max="${it.max}" step="1" value="${it.score}">
        <input type="number" min="1" max="20" step="1" value="${it.max}">
        <div class="pill" title="項目達成率">${ratio}</div>
        <div class="right">
          <button data-act="help">ヒント</button>
          <button data-act="del" class="danger">削除</button>
        </div>
      `;
      const nameInput = row.querySelector("input[type=text]");
      nameInput.onchange = e => { it.name=e.target.value; saveLocal(); render(); };
      const range = row.querySelector("input[type=range]");
      range.oninput = e => { it.score=Number(e.target.value); saveLocal(); render(); };
      const maxInput = row.querySelectorAll("input[type=number]")[0];
      maxInput.oninput = e => {
        const v = Math.max(1, Number(e.target.value||5));
        it.max = v; if(it.score>v) it.score=v;
        saveLocal(); render();
      };
      row.querySelector("[data-act=help]").onclick = ()=>{
        alert(it.help || "評価観点のメモを自由に活用してください。例：駅距離、道路幅員、セットバック、ハザード等");
      };
      row.querySelector("[data-act=del]").onclick = ()=>{
        if(confirm("この項目を削除しますか？")){ cat.items.splice(ii,1); saveLocal(); render(); }
      };
      itemsWrap.appendChild(row);
    });

    document.getElementById("list").appendChild(box);
  });

  document.getElementById("notes").value = model.notes||"";
  document.getElementById("notes").oninput = e => { model.notes = e.target.value; saveLocal(); };

  const score = calcScore();
  document.getElementById("totalScore").textContent = score + " 点";
  document.getElementById("bar").style.width = Math.max(0,Math.min(100,score))+"%";
  document.getElementById("verdict").textContent = verdict(score);
  document.getElementById("threshold").textContent = `${model.threshold}点＝「買い」`;
  document.getElementById("buyThreshold").value = model.threshold;
}

document.getElementById("buyThreshold").oninput = e => { model.threshold = Number(e.target.value||75); saveLocal(); render(); };

document.getElementById("addCategory").onclick = ()=>{
  model.categories.push({id:crypto.randomUUID(), name:"新規カテゴリ", weight:10, items:[]});
  saveLocal(); render();
};
document.getElementById("addItem").onclick = ()=>{
  if(model.categories.length===0){ alert("先にカテゴリを作成してください"); return; }
  const idx = prompt(`何番目のカテゴリに追加しますか？（1〜${model.categories.length}）`, "1");
  const i = Number(idx)-1;
  if(isNaN(i) || i<0 || i>=model.categories.length) return;
  model.categories[i].items.push({id:crypto.randomUUID(), name:"新規項目", score:0, max:5});
  saveLocal(); render();
};

document.getElementById("save").onclick = ()=>{ saveLocal(); alert("保存しました（この端末のブラウザに保存）"); };
document.getElementById("load").onclick = ()=>{ const data = loadLocal(); if(data){ model=data; render(); } else alert("保存データが見つかりません"); };
document.getElementById("export").onclick = exportJSON;
document.getElementById("import").onclick = importJSON;
document.getElementById("reset").onclick = ()=>{
  if(confirm("初期状態に戻しますか？（現在の内容は失われます）")){
    model = structuredClone(DEFAULT_MODEL); saveLocal(); render();
  }
};
document.getElementById("print").onclick = ()=>{ window.print(); };

render();
</script>
</body>
</html>
